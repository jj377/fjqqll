<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>ÂÆ∂Â∫≠‰ªªÂä°Âä©Êâã</title>
    <link rel="manifest" href="manifest.json" type="application/manifest+json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-color: #4A90E2;
            --success-color: #5CB85C;
            --warning-color: #F0AD4E;
            --danger-color: #D9534F;
            --bg-color: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #E1E8ED;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --vh: 1vh;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            min-height: calc(var(--vh, 1vh) * 100);
            background: var(--card-bg); 
        }
        
        .hidden { display: none !important; }
        
        /* Header */
        .header {
            background: var(--primary-color);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title { 
            font-size: 20px; 
            font-weight: 600; 
        }
        
        .role-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
        }
        
        /* Stats Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 20px;
            background: var(--bg-color);
        }
        
        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .stat-value { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--primary-color); 
        }
        
        .stat-label { 
            font-size: 12px; 
            color: var(--text-secondary); 
            margin-top: 4px; 
        }
        
        /* Task List */
        .task-list { 
            padding: 0 20px 80px 20px; 
        }
        
        .task-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 20px 0 10px 0;
            text-transform: uppercase;
        }
        
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }
        
        .task-header { 
            display: flex; 
            align-items: flex-start; 
            gap: 12px; 
        }
        
        .task-content { flex: 1; }
        
        .task-title { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 4px; 
        }
        
        .task-description { 
            font-size: 14px; 
            color: var(--text-secondary); 
            margin-bottom: 8px; 
        }
        
        .task-attachments { 
            margin-top: 12px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
        }
        
        .attachment-item {
            padding: 8px 14px;
            background: var(--bg-color);
            border-radius: 8px;
            font-size: 13px;
            color: var(--primary-color);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .attachment-item:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .attachment-item:active {
            transform: scale(0.98);
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab:hover { 
            transform: scale(1.1); 
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 12px;
            background: var(--bg-color);
        }
        
        /* Attachment Viewer Modal */
        .attachment-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(var(--vh, 1vh) * 100);
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            flex-direction: column;
            pointer-events: none;
        }
        
        .attachment-viewer-modal.active {
            display: flex;
            pointer-events: auto;
        }
        
        .viewer-toolbar {
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: auto;
        }
        
        .viewer-title {
            flex: 1;
            color: white;
            font-size: 14px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 200px;
        }
        
        .viewer-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .viewer-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .viewer-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        .viewer-btn:active {
            transform: scale(0.95);
        }
        
        .viewer-btn-close {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .viewer-btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .viewer-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        
        .viewer-image-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
            cursor: grab;
        }
        
        .viewer-image-container.grabbing {
            cursor: grabbing;
        }
        
        .viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            pointer-events: none;
            user-select: none;
        }
        
        .viewer-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        
        .viewer-fallback {
            color: white;
            text-align: center;
            padding: 40px 20px;
            max-width: 500px;
        }
        
        .viewer-fallback h3 {
            font-size: 20px;
            margin-bottom: 16px;
        }
        
        .viewer-fallback p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 24px;
        }
        
        .viewer-fallback-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }
        
        .viewer-loading {
            color: white;
            text-align: center;
            padding: 40px 20px;
        }
        
        .viewer-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* iOS PDF Object Fallback */
        .pdf-object-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .pdf-object {
            width: 100%;
            flex: 1;
            border: none;
        }
        
        .pdf-fallback-message {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .viewer-title {
                max-width: 120px;
                font-size: 12px;
            }
            
            .viewer-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-height: 44px;
                min-width: 44px;
            }
            
            .viewer-actions {
                gap: 6px;
            }
            
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">ÂÆ∂Â∫≠‰ªªÂä°Âä©Êâã</div>
            <div class="role-badge">Áî®Êà∑</div>
        </div>
        
        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-value">5</div>
                <div class="stat-label">ÂæÖÂäû‰ªªÂä°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">3</div>
                <div class="stat-label">ËøõË°å‰∏≠</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">12</div>
                <div class="stat-label">Â∑≤ÂÆåÊàê</div>
            </div>
        </div>
        
        <!-- Task List -->
        <div class="task-list">
            <div class="task-section-title">‰ªäÊó•‰ªªÂä°</div>
            
            <div class="task-card">
                <div class="task-header">
                    <div class="task-content">
                        <div class="task-title">Êü•ÁúãÊû∂ÊûÑÊñáÊ°£</div>
                        <div class="task-description">ÂÆ°ÈòÖ Flink Êû∂ÊûÑÂõæÂπ∂Êèê‰æõÂèçÈ¶à</div>
                        <div class="task-attachments">
                            <div class="attachment-item" 
                                 data-url="https://example.com/flink_architecture_diagram.png" 
                                 data-type="image/png" 
                                 data-name="flink_architecture_diagram.png">
                                üì∑ Êû∂ÊûÑÂõæ.png
                            </div>
                            <div class="attachment-item" 
                                 data-url="https://example.com/architecture_doc.pdf" 
                                 data-type="application/pdf" 
                                 data-name="architecture_doc.pdf">
                                üìÑ ÊñáÊ°£.pdf
                            </div>
                            <div class="attachment-item" 
                                 data-url="https://example.com/requirements.docx" 
                                 data-type="application/vnd.openxmlformats-officedocument.wordprocessingml.document" 
                                 data-name="requirements.docx">
                                üìù ÈúÄÊ±Ç.docx
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="task-card">
                <div class="task-header">
                    <div class="task-content">
                        <div class="task-title">ÂáÜÂ§áÂë®‰ºöÊùêÊñô</div>
                        <div class="task-description">Êï¥ÁêÜÊú¨Âë®Â∑•‰ΩúÊÄªÁªìÂíå‰∏ãÂë®ËÆ°Âàí</div>
                    </div>
                </div>
            </div>
            
            <div class="task-card">
                <div class="task-header">
                    <div class="task-content">
                        <div class="task-title">‰ª£Á†ÅÂÆ°Êü•</div>
                        <div class="task-description">ÂÆ°Êü•Âõ¢ÈòüÊàêÂëòÊèê‰∫§ÁöÑ‰ª£Á†ÅÂèòÊõ¥</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>ÊúÄÂêéÊõ¥Êñ∞Ôºö2025-12-15</p>
            <div class="kuse-branding" style="margin-top: 12px; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; transition: color 0.2s;" onclick="window.open('https://kuse.ai', '_blank', 'noopener,noreferrer')">
                <span style="font-size: 12px; color: var(--text-secondary);">made with</span>
                <svg viewBox="0,0,160,44" xmlns="http://www.w3.org/2000/svg" style="height: 1.2em; width: auto;"><path d="m.01,20.65C-.43,8.25,9.3-2.03,22.04.34,34.78,2.72,43.29,8.32,43.29,22.9s-8.66,19.01-22.03,20.3C7.9,44.5.46,33.05.01,20.65z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="m146.76,7.94c8.07,0,13.24,6.15,13.24,14.58v1.39h-20.75c.45,4.05,3.51,7.37,8.57,7.37,2.62,0,5.73-1.05,7.62-2.94l2.67,3.83c-2.67,2.55-6.62,3.88-10.9,3.88-8.07,0-14.08-5.6-14.08-14.08,0-7.76,5.67-14.02,13.63-14.02zm0,4.77c-5.01,0-7.29,3.83-7.57,7.1h15.13c-.11-3.16-2.28-7.1-7.57-7.1z" fill="currentColor"/><path d="m86.64,24.49c0,4.15,2.39,6.84,6.84,6.84,4.4,0,6.84-2.69,6.84-6.84V8.55h5.37v16.33c0,6.7-4.06,11.14-12.21,11.14-8.21,0-12.21-4.5-12.21-11.09V8.55h5.37v15.94zm32.99-16.55c4.49,0,8.06,1.47,10.6,3.86l-2.59,3.81c-2.05-2-5.28-3.08-8.06-3.08-2.88,0-4.84,1.37-4.84,3.32,0,1.91,2.64,2.54,5.81,3.27,4.59,1.08,10.26,2.4,10.26,8.46,0,4.94-3.76,8.41-11.14,8.41-4.98,0-8.94-1.76-11.24-4.11l2.54-4.11c1.86,1.91,5.18,3.67,8.84,3.67,3.91,0,5.57-1.66,5.57-3.62,0-2.3-2.88-2.98-6.21-3.76-4.54-1.08-9.87-2.3-9.87-8.06,0-4.5,4.2-8.06,10.31-8.06zM60.79,20.82,71.44,8.55h6.5L66.46,21.26,78.82,35.44h-6.5l-9.28-11.1-2.25,2.49v8.6h-5.33V8.55h5.33v12.27z" fill="currentColor"/></svg>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <button class="fab" title="Ê∑ªÂä†Êñ∞‰ªªÂä°">+</button>
    </div>
    
    <!-- Attachment Viewer Modal -->
    <div class="attachment-viewer-modal" id="attachmentViewer">
        <div class="viewer-toolbar">
            <div class="viewer-title" id="viewerTitle">ÈôÑ‰ª∂È¢ÑËßà</div>
            <div class="viewer-actions">
                <button class="viewer-btn viewer-btn-close" id="btnClose" title="ÂÖ≥Èó≠">‚úï</button>
                <button class="viewer-btn viewer-btn-primary" id="btnDownload" title="‰∏ãËΩΩ">‚¨á</button>
                <button class="viewer-btn" id="btnNewWindow" title="Êñ∞Á™óÂè£ÊâìÂºÄ">‚ßâ</button>
                <button class="viewer-btn" id="btnZoomIn" title="ÊîæÂ§ß">+</button>
                <button class="viewer-btn" id="btnZoomOut" title="Áº©Â∞è">‚àí</button>
                <button class="viewer-btn" id="btnRotate" title="ÊóãËΩ¨">‚Üª</button>
                <button class="viewer-btn" id="btnFullscreen" title="ÂÖ®Â±è">‚õ∂</button>
            </div>
        </div>
        <div class="viewer-content" id="viewerContent">
            <div class="viewer-loading" id="viewerLoading">
                <div class="viewer-loading-spinner"></div>
                <p>Âä†ËΩΩ‰∏≠...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.kuse.ai/sdk.prd.js"></script>
    <script>
        // Fix iOS 100vh issue
        function setVhVariable() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty(`--vh`, `${vh}px`);
        }
        
        setVhVariable();
        window.addEventListener(`resize`, setVhVariable);
        window.addEventListener(`orientationchange`, setVhVariable);
        
        // Utility: Convert HTTP to HTTPS
        function toHttps(url) {
            if (!url) return url;
            return url.replace(/^http:\/\//i, `https://`);
        }
        
        // LeanCloud Safe Initialization
        function initLeanCloud() {
            if (typeof window.LEANCLOUD_CONFIG !== `undefined` && window.LEANCLOUD_CONFIG && typeof AV !== `undefined`) {
                try {
                    AV.init({
                        appId: window.LEANCLOUD_CONFIG.appId,
                        appKey: window.LEANCLOUD_CONFIG.appKey,
                        serverURL: window.LEANCLOUD_CONFIG.serverURL
                    });
                    console.log(`LeanCloud initialized successfully`);
                } catch (error) {
                    console.warn(`LeanCloud initialization failed:`, error);
                }
            } else {
                console.log(`LeanCloud not configured or AV library not loaded`);
            }
        }
        
        // Download File Function
        async function downloadFile(url, filename) {
            const httpsUrl = toHttps(url);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            // Mobile: prefer new window approach
            if (isIOS || isAndroid) {
                const newWindow = window.open(httpsUrl, `_blank`, `noopener,noreferrer`);
                if (newWindow) newWindow.opener = null;
                return;
            }
            
            // Desktop: try fetch blob
            try {
                const response = await fetch(httpsUrl);
                if (!response.ok) throw new Error(`Network response was not ok`);
                
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                
                const a = document.createElement(`a`);
                a.href = blobUrl;
                a.download = filename || `download`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
            } catch (error) {
                console.warn(`Fetch download failed, opening in new window:`, error);
                const newWindow = window.open(httpsUrl, `_blank`, `noopener,noreferrer`);
                if (newWindow) newWindow.opener = null;
            }
        }
        
        // Attachment Viewer
        class AttachmentViewer {
            constructor() {
                this.modal = document.getElementById(`attachmentViewer`);
                this.viewerTitle = document.getElementById(`viewerTitle`);
                this.viewerContent = document.getElementById(`viewerContent`);
                this.viewerLoading = document.getElementById(`viewerLoading`);
                
                this.btnClose = document.getElementById(`btnClose`);
                this.btnDownload = document.getElementById(`btnDownload`);
                this.btnNewWindow = document.getElementById(`btnNewWindow`);
                this.btnZoomIn = document.getElementById(`btnZoomIn`);
                this.btnZoomOut = document.getElementById(`btnZoomOut`);
                this.btnRotate = document.getElementById(`btnRotate`);
                this.btnFullscreen = document.getElementById(`btnFullscreen`);
                
                this.currentUrl = null;
                this.currentType = null;
                this.currentName = null;
                
                this.scale = 1;
                this.rotation = 0;
                this.translateX = 0;
                this.translateY = 0;
                
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;
                this.lastTapTime = 0;
                this.touchStartDistance = 0;
                this.touchStartScale = 1;
                this.touchStartMidpoint = { x: 0, y: 0 };
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                // Close button
                this.btnClose.addEventListener(`click`, () => this.close());
                
                // Download button
                this.btnDownload.addEventListener(`click`, () => {
                    if (this.currentUrl && this.currentName) {
                        downloadFile(this.currentUrl, this.currentName);
                    }
                });
                
                // New window button
                this.btnNewWindow.addEventListener(`click`, () => {
                    if (this.currentUrl) {
                        const newWindow = window.open(toHttps(this.currentUrl), `_blank`, `noopener,noreferrer`);
                        if (newWindow) newWindow.opener = null;
                    }
                });
                
                // Zoom buttons
                this.btnZoomIn.addEventListener(`click`, () => this.zoomIn());
                this.btnZoomOut.addEventListener(`click`, () => this.zoomOut());
                
                // Rotate button
                this.btnRotate.addEventListener(`click`, () => this.rotate());
                
                // Fullscreen button
                this.btnFullscreen.addEventListener(`click`, () => this.toggleFullscreen());
                
                // Backdrop click to close
                this.modal.addEventListener(`click`, (e) => {
                    if (e.target === this.modal) {
                        this.close();
                    }
                });
                
                // ESC key to close
                document.addEventListener(`keydown`, (e) => {
                    if (e.key === `Escape` && this.modal.classList.contains(`active`)) {
                        this.close();
                    }
                });
            }
            
            open(url, type, name) {
                this.currentUrl = toHttps(url);
                this.currentType = type;
                this.currentName = name;
                
                this.viewerTitle.textContent = name || `ÈôÑ‰ª∂È¢ÑËßà`;
                this.modal.classList.add(`active`);
                document.body.style.overflow = `hidden`;
                
                this.resetTransform();
                this.showLoading();
                
                if (type.startsWith(`image/`)) {
                    this.loadImage(this.currentUrl);
                } else if (type === `application/pdf`) {
                    this.loadPdf(this.currentUrl);
                } else if (type.includes(`word`) || type.includes(`document`)) {
                    this.loadDocument(this.currentUrl);
                } else {
                    this.showFallback(`‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã`);
                }
            }
            
            close() {
                this.modal.classList.remove(`active`);
                document.body.style.overflow = ``;
                this.viewerContent.innerHTML = ``;
                this.currentUrl = null;
                this.currentType = null;
                this.currentName = null;
            }
            
            showLoading() {
                this.viewerContent.innerHTML = `
                    <div class="viewer-loading">
                        <div class="viewer-loading-spinner"></div>
                        <p>Âä†ËΩΩ‰∏≠...</p>
                    </div>
                `;
            }
            
            showFallback(message) {
                this.viewerContent.innerHTML = `
                    <div class="viewer-fallback">
                        <h3>${message}</h3>
                        <p>ÊÇ®ÂèØ‰ª•‰∏ãËΩΩÊñá‰ª∂ÊàñÂú®Êñ∞Á™óÂè£‰∏≠ÊâìÂºÄ</p>
                        <div class="viewer-fallback-actions">
                            <button class="viewer-btn viewer-btn-primary" onclick="attachmentViewer.downloadCurrent()">‰∏ãËΩΩÊñá‰ª∂</button>
                            <button class="viewer-btn" onclick="attachmentViewer.openInNewWindow()">Âú®Êñ∞Á™óÂè£ÊâìÂºÄ</button>
                        </div>
                    </div>
                `;
            }
            
            loadImage(url) {
                const container = document.createElement(`div`);
                container.className = `viewer-image-container`;
                
                const img = document.createElement(`img`);
                img.className = `viewer-image`;
                img.src = url;
                
                img.onload = () => {
                    this.viewerContent.innerHTML = ``;
                    container.appendChild(img);
                    this.viewerContent.appendChild(container);
                    this.initImageInteractions(container, img);
                };
                
                img.onerror = () => {
                    this.showFallback(`ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•`);
                };
            }
            
            initImageInteractions(container, img) {
                // Double-tap to zoom
                container.addEventListener(`click`, (e) => {
                    const now = Date.now();
                    const timeSinceLastTap = now - this.lastTapTime;
                    
                    if (timeSinceLastTap < 300 && timeSinceLastTap > 0) {
                        // Double tap detected
                        this.scale = this.scale === 1 ? 2 : 1;
                        this.translateX = 0;
                        this.translateY = 0;
                        this.updateImageTransform(img);
                    }
                    
                    this.lastTapTime = now;
                });
                
                // Mouse drag
                container.addEventListener(`mousedown`, (e) => {
                    if (this.scale > 1) {
                        this.isDragging = true;
                        this.startX = e.clientX - this.translateX;
                        this.startY = e.clientY - this.translateY;
                        container.classList.add(`grabbing`);
                    }
                });
                
                document.addEventListener(`mousemove`, (e) => {
                    if (this.isDragging) {
                        this.translateX = e.clientX - this.startX;
                        this.translateY = e.clientY - this.startY;
                        this.updateImageTransform(img);
                    }
                });
                
                document.addEventListener(`mouseup`, () => {
                    this.isDragging = false;
                    container.classList.remove(`grabbing`);
                });
                
                // Touch drag (single finger)
                container.addEventListener(`touchstart`, (e) => {
                    if (e.touches.length === 1 && this.scale > 1) {
                        this.isDragging = true;
                        this.startX = e.touches[0].clientX - this.translateX;
                        this.startY = e.touches[0].clientY - this.translateY;
                    } else if (e.touches.length === 2) {
                        // Pinch zoom start
                        this.isDragging = false;
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        this.touchStartDistance = this.getDistance(touch1, touch2);
                        this.touchStartScale = this.scale;
                        this.touchStartMidpoint = this.getMidpoint(touch1, touch2);
                    }
                });
                
                container.addEventListener(`touchmove`, (e) => {
                    if (e.touches.length === 1 && this.isDragging) {
                        e.preventDefault();
                        this.translateX = e.touches[0].clientX - this.startX;
                        this.translateY = e.touches[0].clientY - this.startY;
                        this.updateImageTransform(img);
                    } else if (e.touches.length === 2) {
                        e.preventDefault();
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const currentDistance = this.getDistance(touch1, touch2);
                        const scaleChange = currentDistance / this.touchStartDistance;
                        this.scale = Math.max(0.5, Math.min(5, this.touchStartScale * scaleChange));
                        this.updateImageTransform(img);
                    }
                });
                
                container.addEventListener(`touchend`, () => {
                    this.isDragging = false;
                });
                
                // Mouse wheel zoom
                container.addEventListener(`wheel`, (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    this.scale = Math.max(0.5, Math.min(5, this.scale * delta));
                    this.updateImageTransform(img);
                });
            }
            
            getDistance(touch1, touch2) {
                const dx = touch2.clientX - touch1.clientX;
                const dy = touch2.clientY - touch1.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
            
            getMidpoint(touch1, touch2) {
                return {
                    x: (touch1.clientX + touch2.clientX) / 2,
                    y: (touch1.clientY + touch2.clientY) / 2
                };
            }
            
            updateImageTransform(img) {
                img.style.transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale}) rotate(${this.rotation}deg)`;
            }
            
            zoomIn() {
                this.scale = Math.min(5, this.scale + 0.25);
                const img = this.viewerContent.querySelector(`.viewer-image`);
                if (img) this.updateImageTransform(img);
            }
            
            zoomOut() {
                this.scale = Math.max(0.5, this.scale - 0.25);
                const img = this.viewerContent.querySelector(`.viewer-image`);
                if (img) this.updateImageTransform(img);
            }
            
            rotate() {
                this.rotation = (this.rotation + 90) % 360;
                const img = this.viewerContent.querySelector(`.viewer-image`);
                if (img) this.updateImageTransform(img);
            }
            
            resetTransform() {
                this.scale = 1;
                this.rotation = 0;
                this.translateX = 0;
                this.translateY = 0;
            }
            
            loadPdf(url) {
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const isMobileSafari = isIOS && /Safari/i.test(navigator.userAgent) && !/CriOS|FxiOS/i.test(navigator.userAgent);
                
                // Try self-hosted pdf.js first (not available in this workspace)
                const selfHostedViewer = `/pdfjs/web/viewer.html?file=${encodeURIComponent(url)}`;
                const mozillaViewer = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(url)}`;
                
                // For iOS Mobile Safari, use object/embed with fallback
                if (isMobileSafari) {
                    this.viewerContent.innerHTML = `
                        <div class="pdf-object-container">
                            <object class="pdf-object" type="application/pdf" data="${url}">
                                <div class="pdf-fallback-message">
                                    <p>ÊÇ®ÁöÑÊµèËßàÂô®ÂèØËÉΩÊó†Ê≥ïÁõ¥Êé•È¢ÑËßà PDF</p>
                                    <button class="viewer-btn viewer-btn-primary" onclick="attachmentViewer.openInNewWindow()" style="margin-top: 12px;">Âú®Êñ∞Á™óÂè£ÊâìÂºÄ PDF</button>
                                </div>
                            </object>
                        </div>
                    `;
                } else {
                    // Use Mozilla pdf.js viewer for other browsers
                    const iframe = document.createElement(`iframe`);
                    iframe.className = `viewer-iframe`;
                    iframe.src = mozillaViewer;
                    
                    this.viewerContent.innerHTML = ``;
                    this.viewerContent.appendChild(iframe);
                    
                    // Fallback if iframe fails to load
                    setTimeout(() => {
                        if (!iframe.contentWindow || iframe.contentWindow.length === 0) {
                            this.showFallback(`PDF Âä†ËΩΩÂ§±Ë¥•`);
                        }
                    }, 5000);
                }
            }
            
            loadDocument(url) {
                const officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(url)}`;
                const iframe = document.createElement(`iframe`);
                iframe.className = `viewer-iframe`;
                iframe.src = officeViewerUrl;
                
                this.viewerContent.innerHTML = ``;
                this.viewerContent.appendChild(iframe);
                
                // 5 second timeout fallback
                setTimeout(() => {
                    if (!iframe.contentWindow || iframe.contentWindow.length === 0) {
                        this.showFallback(`ÊñáÊ°£È¢ÑËßàÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®`);
                    }
                }, 5000);
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    this.modal.requestFullscreen().catch(err => {
                        console.warn(`Fullscreen request failed:`, err);
                    });
                } else {
                    document.exitFullscreen();
                }
            }
            
            downloadCurrent() {
                if (this.currentUrl && this.currentName) {
                    downloadFile(this.currentUrl, this.currentName);
                }
            }
            
            openInNewWindow() {
                if (this.currentUrl) {
                    const newWindow = window.open(toHttps(this.currentUrl), `_blank`, `noopener,noreferrer`);
                    if (newWindow) newWindow.opener = null;
                }
            }
        }
        
        // Initialize attachment viewer
        const attachmentViewer = new AttachmentViewer();
        
        // Global function to open attachments
        function openAttachment(url, type, name) {
            attachmentViewer.open(url, type, name);
        }
        
        // Attach click handlers to attachment items
        document.addEventListener(`DOMContentLoaded`, () => {
            const attachmentItems = document.querySelectorAll(`.attachment-item`);
            
            attachmentItems.forEach(item => {
                item.addEventListener(`click`, function() {
                    const url = this.getAttribute(`data-url`);
                    const type = this.getAttribute(`data-type`);
                    const name = this.getAttribute(`data-name`);
                    
                    if (url && type && name) {
                        openAttachment(url, type, name);
                    }
                });
            });
            
            // Initialize LeanCloud
            initLeanCloud();
        });
        
        // FAB click handler
        document.querySelector(`.fab`).addEventListener(`click`, () => {
            alert(`Ê∑ªÂä†Êñ∞‰ªªÂä°ÂäüËÉΩÂæÖÂÆûÁé∞`);
        });
    </script>
</body>
</html>
