<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å®¶åº­ä»»åŠ¡åŠ©æ‰‹</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.txt">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-color: #4A90E2;
            --success-color: #5CB85C;
            --warning-color: #F0AD4E;
            --danger-color: #D9534F;
            --bg-color: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #E1E8ED;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--card-bg); }
        .hidden { display: none !important; }
        
        /* ç™»å½•é¡µé¢ */
        #loginPage {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            background: white; border-radius: 16px; padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 400px;
        }
        
        .login-title { font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 10px; color: var(--primary-color); }
        .login-subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 14px; }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .input-group input {
            width: 100%; padding: 12px 16px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 16px;
        }
        .input-group input:focus { outline: none; border-color: var(--primary-color); }
        
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #357ABD; transform: translateY(-2px); }
        .btn-secondary { background: var(--text-secondary); color: white; margin-top: 10px; }
        
        .divider {
            text-align: center; margin: 20px 0; color: var(--text-secondary); position: relative;
        }
        .divider::before, .divider::after {
            content: ''; position: absolute; top: 50%; width: 40%; height: 1px;
            background: var(--border-color);
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        
        /* å¤´éƒ¨ */
        .header {
            background: var(--primary-color); color: white; padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-title { font-size: 20px; font-weight: 600; }
        .role-badge {
            background: rgba(255,255,255,0.2); padding: 4px 12px;
            border-radius: 12px; font-size: 14px;
        }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* æµ®åŠ¨æŒ‰é’® */
        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
            background: var(--primary-color); border-radius: 50%; border: none;
            color: white; font-size: 28px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;
        }
        .fab:hover { transform: scale(1.1); }
        
        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            padding: 20px; background: var(--bg-color);
        }
        .stat-card {
            background: white; padding: 16px; border-radius: 12px;
            text-align: center; box-shadow: var(--shadow);
        }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary-color); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list { padding: 0 20px 80px 20px; }
        .task-section-title {
            font-size: 14px; font-weight: 600; color: var(--text-secondary);
            margin: 20px 0 10px 0; text-transform: uppercase;
        }
        
        .task-card {
            background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px;
            box-shadow: var(--shadow); border-left: 4px solid transparent;
        }
        .task-card.priority-high { border-left-color: var(--danger-color); }
        .task-card.priority-medium { border-left-color: var(--warning-color); }
        .task-card.priority-low { border-left-color: var(--success-color); }
        .task-card.completed { opacity: 0.6; background: #f9f9f9; }
        
        .task-header { display: flex; align-items: flex-start; gap: 12px; }
        .task-checkbox {
            width: 24px; height: 24px; min-width: 24px; border: 2px solid var(--border-color);
            border-radius: 6px; cursor: pointer; display: flex; align-items: center;
            justify-content: center;
        }
        .task-checkbox:hover { border-color: var(--primary-color); }
        .task-checkbox.checked {
            background: var(--success-color); border-color: var(--success-color);
        }
        .task-checkbox.checked::after {
            content: 'âœ“'; color: white; font-size: 16px; font-weight: bold;
        }
        
        .task-content { flex: 1; }
        .task-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .task-title.completed { text-decoration: line-through; color: var(--text-secondary); }
        .task-description { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        
        .task-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .task-tag {
            display: inline-block; padding: 4px 10px; background: var(--bg-color);
            border-radius: 12px; font-size: 12px; color: var(--text-secondary);
        }
        .task-due-date { font-size: 12px; color: var(--text-secondary); }
        .task-due-date.overdue { color: var(--danger-color); font-weight: 600; }
        
        .task-attachments { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
        .attachment-item {
            padding: 6px 12px; background: var(--bg-color); border-radius: 8px;
            font-size: 13px; color: var(--primary-color); cursor: pointer;
        }
        .attachment-item:hover { background: #e3f2fd; }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 16px; padding: 24px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .modal-title { font-size: 20px; font-weight: 600; }
        .close-btn {
            background: none; border: none; font-size: 28px;
            cursor: pointer; color: var(--text-secondary);
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%; padding: 10px 12px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 14px;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus { outline: none; border-color: var(--primary-color); }
        
        .file-upload {
            border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer;
        }
        .file-upload:hover { border-color: var(--primary-color); background: var(--bg-color); }
        .file-upload input { display: none; }
        
        .uploaded-files { margin-top: 12px; }
        .uploaded-file {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: var(--bg-color); border-radius: 8px; margin-bottom: 8px;
        }
        .remove-file {
            background: var(--danger-color); color: white; border: none;
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
        }
        
        .empty-state {
            text-align: center; padding: 60px 20px; color: var(--text-secondary);
        }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 24px; font-size: 14px; z-index: 3000; opacity: 0;
        }
        .toast.show { opacity: 1; }
        
        /* ç³»ç»Ÿæ¶æ„æ¨¡æ€æ¡†æ ·å¼ - æ–°å¢ */
        .architecture-modal .modal-content {
            max-width: 90%;
            max-height: 90vh;
            padding: 20px;
        }
        .architecture-modal img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }
        .architecture-caption {
            text-align: center;
            margin-top: 12px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* é™„ä»¶é¢„è§ˆå¢å¼ºæ ·å¼ - æ–°å¢ */
        .preview-iframe {
            width: 100%;
            height: 70vh;
            border: none;
            border-radius: 8px;
        }
        .preview-fallback {
            text-align: center;
            padding: 40px;
        }
        .preview-fallback-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .download-btn {
            display: inline-block;
            margin-top: 12px;
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .download-btn:hover {
            background: #357ABD;
        }
        
        @media (max-width: 480px) {
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
            .stat-card:last-child { grid-column: 1 / -1; }
            .preview-iframe { height: 50vh; }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage">
        <div class="login-card">
            <h1 class="login-title">ğŸ‘¨â€ğŸ‘§ å®¶åº­ä»»åŠ¡åŠ©æ‰‹</h1>
            <p class="login-subtitle">è®©ä»»åŠ¡ç®¡ç†æ›´ç®€å•</p>
            
            <div id="loginForm">
                <div class="input-group">
                    <label>å®¶åº­é‚€è¯·ç </label>
                    <input type="text" id="inviteCodeInput" placeholder="è¾“å…¥6ä½é‚€è¯·ç " maxlength="6">
                </div>
                <button class="btn btn-primary" onclick="loginWithCode()">ç™»å½•</button>
                <div class="divider">æˆ–</div>
                <button class="btn btn-secondary" onclick="createFamily()">åˆ›å»ºæ–°å®¶åº­</button>
            </div>

            <div id="roleSelection" class="hidden">
                <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">è¯·é€‰æ‹©ä½ çš„è§’è‰²</p>
                <button class="btn btn-primary" onclick="selectRole('parent')">ğŸ‘¨â€ğŸ’¼ å®¶é•¿æ¨¡å¼</button>
                <button class="btn btn-secondary" onclick="selectRole('child')">ğŸ‘§ å­©å­æ¨¡å¼</button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <!-- å¤´éƒ¨å¯¼èˆª -->
            <div class="header">
                <div>
                    <div class="header-title">å®¶åº­ä»»åŠ¡</div>
                    <div class="role-badge" id="roleBadge"></div>
                </div>
                <div class="header-actions">
                    <!-- æ–°å¢ç³»ç»Ÿæ¶æ„æŒ‰é’® -->
                    <button class="icon-btn" onclick="openArchitectureModal()" title="ç³»ç»Ÿæ¶æ„">ğŸ—ï¸</button>
                    <button class="icon-btn" onclick="switchRole()" title="åˆ‡æ¢è§’è‰²">ğŸ”„</button>
                    <button class="icon-btn" onclick="logout()" title="é€€å‡º">ğŸšª</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div id="statsPanel" class="stats-panel hidden">
                <div class="stat-card">
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">æ€»ä»»åŠ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedTasks">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completionRate">0%</div>
                    <div class="stat-label">å®Œæˆç‡</div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="task-list" id="taskList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- åˆ›å»ºä»»åŠ¡æµ®åŠ¨æŒ‰é’® -->
            <button id="createTaskBtn" class="fab hidden" onclick="openCreateTaskModal()">+</button>
        </div>
    </div>

    <!-- åˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡† -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åˆ›å»ºæ–°ä»»åŠ¡</h2>
                <button class="close-btn" onclick="closeCreateTaskModal()">&times;</button>
            </div>
            
            <form id="taskForm" onsubmit="createTask(event)">
                <div class="form-group">
                    <label>ä»»åŠ¡æ ‡é¢˜ *</label>
                    <input type="text" id="taskTitle" required placeholder="ä¾‹å¦‚:å®Œæˆæ•°å­¦ä½œä¸š">
                </div>

                <div class="form-group">
                    <label>ä»»åŠ¡æè¿°</label>
                    <textarea id="taskDescription" placeholder="è¯¦ç»†è¯´æ˜ä»»åŠ¡è¦æ±‚..."></textarea>
                </div>

                <div class="form-group">
                    <label>æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="taskDueDate">
                </div>

                <div class="form-group">
                    <label>ä¼˜å…ˆçº§</label>
                    <select id="taskPriority">
                        <option value="low">ä½</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="high">é«˜</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾(ç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="taskTags" placeholder="ä¾‹å¦‚:ä½œä¸š,æ•°å­¦">
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ é™„ä»¶</label>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <div>ğŸ“ ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                            æ”¯æŒPDFã€DOCXã€å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘
                        </div>
                        <!-- æ›´æ–°æ–‡ä»¶ç±»å‹æ¥å—åˆ—è¡¨ï¼Œå¢åŠ DOCXå’ŒPDFæ”¯æŒ -->
                        <input type="file" id="fileInput" multiple 
                               accept=".pdf,.docx,.doc,.jpg,.jpeg,.png,.gif,.mp3,.mp4,.wav,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document" 
                               onchange="handleFileSelect(event)">
                    </div>
                    <div id="uploadedFilesList" class="uploaded-files"></div>
                </div>

                <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
            </form>
        </div>
    </div>

    <!-- é™„ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="attachmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="attachmentTitle">æŸ¥çœ‹é™„ä»¶</h2>
                <button class="close-btn" onclick="closeAttachmentModal()">&times;</button>
            </div>
            <div id="attachmentContent"></div>
        </div>
    </div>

    <!-- ç³»ç»Ÿæ¶æ„æ¨¡æ€æ¡† - æ–°å¢ -->
    <div id="architectureModal" class="modal architecture-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç³»ç»Ÿæ¶æ„</h2>
                <button class="close-btn" onclick="closeArchitectureModal()">&times;</button>
            </div>
            <div style="text-align: center;">
                <img src="../My%20First%20Project/flink_architecture_diagram.png" 
                     alt="Flink Architecture Diagram"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="preview-fallback" style="display: none;">
                    <div class="preview-fallback-icon">ğŸ—ï¸</div>
                    <div>æ¶æ„å›¾åŠ è½½å¤±è´¥</div>
                </div>
                <p class="architecture-caption">Flink Architecture Diagram</p>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div id="toast" class="toast"></div>

    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    
    <script>
        // ========== LeanCloud é…ç½® ==========
        // è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…é…ç½®ä¿¡æ¯
        const LEANCLOUD_APP_ID = `YOUR_APP_ID`;
        const LEANCLOUD_APP_KEY = `YOUR_APP_KEY`;
        const LEANCLOUD_SERVER_URL = `https://YOUR_SERVER_URL.lc-cn-n1-shared.com`;

        // åˆå§‹åŒ–LeanCloud
        AV.init({
            appId: LEANCLOUD_APP_ID,
            appKey: LEANCLOUD_APP_KEY,
            serverURL: LEANCLOUD_SERVER_URL
        });

        // ========== å…¨å±€å˜é‡ ==========
        let currentUser = null;
        let currentRole = null;
        let currentFamily = null;
        let tasks = [];
        let uploadedFiles = [];

        // ========== å®¶åº­ç®¡ç†åŠŸèƒ½ ==========
        
        /**
         * åˆ›å»ºæ–°å®¶åº­
         * ç”Ÿæˆ6ä½éšæœºé‚€è¯·ç å¹¶ä¿å­˜åˆ°LeanCloud
         */
        async function createFamily() {
            try {
                showToast(`æ­£åœ¨åˆ›å»ºå®¶åº­...`);
                const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const Family = AV.Object.extend(`Family`);
                const family = new Family();
                family.set(`inviteCode`, inviteCode);
                family.set(`createdAt`, new Date());
                await family.save();
                
                localStorage.setItem(`familyId`, family.id);
                localStorage.setItem(`inviteCode`, inviteCode);
                
                alert(`å®¶åº­åˆ›å»ºæˆåŠŸ!\n\né‚€è¯·ç :${inviteCode}\n\nè¯·å°†æ­¤é‚€è¯·ç åˆ†äº«ç»™å­©å­`);
                currentFamily = family;
                showRoleSelection();
            } catch (error) {
                console.error(`åˆ›å»ºå®¶åº­å¤±è´¥:`, error);
                showToast(`åˆ›å»ºå¤±è´¥,è¯·é‡è¯•`);
            }
        }

        /**
         * ä½¿ç”¨é‚€è¯·ç ç™»å½•
         * éªŒè¯é‚€è¯·ç å¹¶åŠ å…¥å¯¹åº”å®¶åº­
         */
        async function loginWithCode() {
            const code = document.getElementById(`inviteCodeInput`).value.trim().toUpperCase();
            if (!code || code.length !== 6) {
                showToast(`è¯·è¾“å…¥6ä½é‚€è¯·ç `);
                return;
            }
            
            try {
                showToast(`æ­£åœ¨éªŒè¯é‚€è¯·ç ...`);
                const query = new AV.Query(`Family`);
                query.equalTo(`inviteCode`, code);
                const family = await query.first();
                
                if (!family) {
                    showToast(`é‚€è¯·ç æ— æ•ˆ`);
                    return;
                }
                
                localStorage.setItem(`familyId`, family.id);
                localStorage.setItem(`inviteCode`, code);
                currentFamily = family;
                showRoleSelection();
            } catch (error) {
                console.error(`ç™»å½•å¤±è´¥:`, error);
                showToast(`ç™»å½•å¤±è´¥,è¯·é‡è¯•`);
            }
        }

        /**
         * æ˜¾ç¤ºè§’è‰²é€‰æ‹©ç•Œé¢
         */
        function showRoleSelection() {
            document.getElementById(`loginForm`).classList.add(`hidden`);
            document.getElementById(`roleSelection`).classList.remove(`hidden`);
        }

        /**
         * é€‰æ‹©ç”¨æˆ·è§’è‰²ï¼ˆå®¶é•¿/å­©å­ï¼‰
         * @param {string} role - è§’è‰²ç±»å‹ 'parent' æˆ– 'child'
         */
        function selectRole(role) {
            currentRole = role;
            localStorage.setItem(`userRole`, role);
            document.getElementById(`loginPage`).classList.add(`hidden`);
            document.getElementById(`mainApp`).classList.remove(`hidden`);
            initApp();
        }

        /**
         * åˆ‡æ¢ç”¨æˆ·è§’è‰²
         */
        function switchRole() {
            const newRole = currentRole === `parent` ? `child` : `parent`;
            selectRole(newRole);
        }

        /**
         * é€€å‡ºç™»å½•
         */
        function logout() {
            if (confirm(`ç¡®å®šè¦é€€å‡ºå—?`)) {
                localStorage.clear();
                location.reload();
            }
        }

        // ========== åº”ç”¨åˆå§‹åŒ– ==========
        
        /**
         * åˆå§‹åŒ–ä¸»åº”ç”¨
         * æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„ç•Œé¢å…ƒç´ 
         */
        async function initApp() {
            const roleBadge = document.getElementById(`roleBadge`);
            roleBadge.textContent = currentRole === `parent` ? `ğŸ‘¨â€ğŸ’¼ å®¶é•¿` : `ğŸ‘§ å­©å­`;
            
            // å®¶é•¿æ¨¡å¼æ˜¾ç¤ºç»Ÿè®¡é¢æ¿å’Œåˆ›å»ºæŒ‰é’®
            if (currentRole === `parent`) {
                document.getElementById(`statsPanel`).classList.remove(`hidden`);
                document.getElementById(`createTaskBtn`).classList.remove(`hidden`);
            } else {
                document.getElementById(`statsPanel`).classList.add(`hidden`);
                document.getElementById(`createTaskBtn`).classList.add(`hidden`);
            }
            
            await loadTasks();
            setupRealtimeSync();
        }

        // ========== ä»»åŠ¡ç®¡ç†åŠŸèƒ½ ==========
        
        /**
         * ä»LeanCloudåŠ è½½ä»»åŠ¡åˆ—è¡¨
         */
        async function loadTasks() {
            try {
                const familyId = localStorage.getItem(`familyId`);
                const query = new AV.Query(`Task`);
                query.equalTo(`familyId`, familyId);
                query.descending(`createdAt`);
                const results = await query.find();
                
                tasks = results.map(obj => ({
                    id: obj.id,
                    ...obj.toJSON()
                }));
                
                renderTasks();
                updateStats();
            } catch (error) {
                console.error(`åŠ è½½ä»»åŠ¡å¤±è´¥:`, error);
                showToast(`åŠ è½½å¤±è´¥`);
            }
        }

        /**
         * æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
         */
        function renderTasks() {
            const taskList = document.getElementById(`taskList`);
            
            if (tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>è¿˜æ²¡æœ‰ä»»åŠ¡</div>
                        ${currentRole === `parent` ? `<div style="margin-top: 8px; font-size: 14px;">ç‚¹å‡»å³ä¸‹è§’ + åˆ›å»ºä»»åŠ¡</div>` : ``}
                    </div>
                `;
                return;
            }
            
            const pending = tasks.filter(t => !t.completed);
            const completed = tasks.filter(t => t.completed);
            let html = ``;
            
            if (pending.length > 0) {
                html += `<div class="task-section-title">å¾…å®Œæˆ</div>`;
                pending.forEach(task => { html += renderTaskCard(task); });
            }
            
            if (completed.length > 0) {
                html += `<div class="task-section-title">å·²å®Œæˆ</div>`;
                completed.forEach(task => { html += renderTaskCard(task); });
            }
            
            taskList.innerHTML = html;
        }

        /**
         * æ¸²æŸ“å•ä¸ªä»»åŠ¡å¡ç‰‡
         * @param {Object} task - ä»»åŠ¡å¯¹è±¡
         * @returns {string} HTMLå­—ç¬¦ä¸²
         */
        function renderTaskCard(task) {
            const dueDate = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && !task.completed;
            
            return `
                <div class="task-card priority-${task.priority} ${task.completed ? `completed` : ``}">
                    <div class="task-header">
                        <div class="task-checkbox ${task.completed ? `checked` : ``}" 
                             onclick="toggleTask('${task.id}')"></div>
                        <div class="task-content">
                            <div class="task-title ${task.completed ? `completed` : ``}">
                                ${escapeHtml(task.title)}
                            </div>
                            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ``}
                            <div class="task-meta">
                                ${task.tags && task.tags.length > 0 ? task.tags.map(tag => 
                                    `<span class="task-tag">#${escapeHtml(tag)}</span>`
                                ).join(``) : ``}
                                ${dueDate ? `
                                    <div class="task-due-date ${isOverdue ? `overdue` : ``}">
                                        ğŸ“… ${formatDate(dueDate)}
                                    </div>
                                ` : ``}
                            </div>
                            ${task.attachments && task.attachments.length > 0 ? `
                                <div class="task-attachments">
                                    ${task.attachments.map((att, idx) => `
                                        <div class="attachment-item" onclick="viewAttachment('${task.id}', ${idx})">
                                            ${getFileIcon(att.type, att.name)} ${escapeHtml(att.name)}
                                        </div>
                                    `).join(``)}
                                </div>
                            ` : ``}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
         * @param {string} taskId - ä»»åŠ¡ID
         */
        async function toggleTask(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;
                
                const Task = AV.Object.createWithoutData(`Task`, taskId);
                Task.set(`completed`, !task.completed);
                Task.set(`completedAt`, !task.completed ? new Date() : null);
                await Task.save();
                
                task.completed = !task.completed;
                task.completedAt = task.completed ? new Date() : null;
                
                renderTasks();
                updateStats();
                showToast(task.completed ? `âœ“ ä»»åŠ¡å·²å®Œæˆ` : `ä»»åŠ¡æ ‡è®°ä¸ºæœªå®Œæˆ`);
            } catch (error) {
                console.error(`æ›´æ–°ä»»åŠ¡å¤±è´¥:`, error);
                showToast(`æ“ä½œå¤±è´¥`);
            }
        }

        /**
         * æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼ˆä»…å®¶é•¿æ¨¡å¼ï¼‰
         */
        function updateStats() {
            if (currentRole !== `parent`) return;
            
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById(`totalTasks`).textContent = total;
            document.getElementById(`completedTasks`).textContent = completed;
            document.getElementById(`completionRate`).textContent = rate + `%`;
        }

        // ========== åˆ›å»ºä»»åŠ¡åŠŸèƒ½ ==========
        
        /**
         * æ‰“å¼€åˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡†
         */
        function openCreateTaskModal() {
            document.getElementById(`createTaskModal`).classList.add(`active`);
            
            // é»˜è®¤è®¾ç½®æ˜å¤©ä¸ºæˆªæ­¢æ—¥æœŸ
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById(`taskDueDate`).value = tomorrow.toISOString().split(`T`)[0];
        }

        /**
         * å…³é—­åˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡†
         */
        function closeCreateTaskModal() {
            document.getElementById(`createTaskModal`).classList.remove(`active`);
            document.getElementById(`taskForm`).reset();
            uploadedFiles = [];
            document.getElementById(`uploadedFilesList`).innerHTML = ``;
        }

        /**
         * å¤„ç†æ–‡ä»¶é€‰æ‹©å’Œä¸Šä¼ 
         * @param {Event} event - æ–‡ä»¶è¾“å…¥äº‹ä»¶
         */
        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            for (const file of files) {
                // é™åˆ¶å•ä¸ªæ–‡ä»¶å¤§å°ä¸º10MB
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name} è¶…è¿‡10MBé™åˆ¶`);
                    continue;
                }
                
                try {
                    showToast(`æ­£åœ¨ä¸Šä¼ ...`);
                    const avFile = new AV.File(file.name, file);
                    await avFile.save();
                    
                    uploadedFiles.push({
                        name: file.name,
                        url: avFile.url(),
                        type: file.type
                    });
                    
                    renderUploadedFiles();
                    showToast(`${file.name} ä¸Šä¼ æˆåŠŸ`);
                } catch (error) {
                    console.error(`ä¸Šä¼ å¤±è´¥:`, error);
                    showToast(`${file.name} ä¸Šä¼ å¤±è´¥`);
                }
            }
            
            event.target.value = ``;
        }

        /**
         * æ¸²æŸ“å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
         */
        function renderUploadedFiles() {
            const list = document.getElementById(`uploadedFilesList`);
            list.innerHTML = uploadedFiles.map((file, idx) => `
                <div class="uploaded-file">
                    <span>${getFileIcon(file.type, file.name)} ${escapeHtml(file.name)}</span>
                    <button type="button" class="remove-file" onclick="removeFile(${idx})">&times;</button>
                </div>
            `).join(``);
        }

        /**
         * ç§»é™¤å·²ä¸Šä¼ æ–‡ä»¶
         * @param {number} index - æ–‡ä»¶ç´¢å¼•
         */
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderUploadedFiles();
        }

        /**
         * åˆ›å»ºæ–°ä»»åŠ¡
         * @param {Event} event - è¡¨å•æäº¤äº‹ä»¶
         */
        async function createTask(event) {
            event.preventDefault();
            
            try {
                showToast(`æ­£åœ¨åˆ›å»ºä»»åŠ¡...`);
                
                const title = document.getElementById(`taskTitle`).value.trim();
                const description = document.getElementById(`taskDescription`).value.trim();
                const dueDate = document.getElementById(`taskDueDate`).value;
                const priority = document.getElementById(`taskPriority`).value;
                const tagsInput = document.getElementById(`taskTags`).value.trim();
                const tags = tagsInput ? tagsInput.split(`,`).map(t => t.trim()).filter(t => t) : [];
                
                const Task = AV.Object.extend(`Task`);
                const task = new Task();
                task.set(`familyId`, localStorage.getItem(`familyId`));
                task.set(`title`, title);
                task.set(`description`, description);
                task.set(`dueDate`, dueDate ? new Date(dueDate) : null);
                task.set(`priority`, priority);
                task.set(`tags`, tags);
                task.set(`attachments`, uploadedFiles);
                task.set(`completed`, false);
                task.set(`createdBy`, `parent`);
                
                await task.save();
                
                showToast(`âœ“ ä»»åŠ¡åˆ›å»ºæˆåŠŸ`);
                closeCreateTaskModal();
                await loadTasks();
            } catch (error) {
                console.error(`åˆ›å»ºä»»åŠ¡å¤±è´¥:`, error);
                showToast(`åˆ›å»ºå¤±è´¥,è¯·é‡è¯•`);
            }
        }

        // ========== é™„ä»¶é¢„è§ˆåŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼‰ ==========
        
        /**
         * æŸ¥çœ‹é™„ä»¶
         * æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ã€PDFå’ŒDOCXé¢„è§ˆ
         * @param {string} taskId - ä»»åŠ¡ID
         * @param {number} attachmentIndex - é™„ä»¶ç´¢å¼•
         */
        function viewAttachment(taskId, attachmentIndex) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.attachments || !task.attachments[attachmentIndex]) return;
            
            const attachment = task.attachments[attachmentIndex];
            const modal = document.getElementById(`attachmentModal`);
            const title = document.getElementById(`attachmentTitle`);
            const content = document.getElementById(`attachmentContent`);
            
            title.textContent = attachment.name;
            
            // å›¾ç‰‡é¢„è§ˆ
            if (attachment.type.startsWith(`image/`)) {
                content.innerHTML = `<img src="${attachment.url}" alt="${escapeHtml(attachment.name)}" style="max-width: 100%; border-radius: 8px;">`;
            } 
            // è§†é¢‘é¢„è§ˆ
            else if (attachment.type.startsWith(`video/`)) {
                content.innerHTML = `<video controls src="${attachment.url}" class="preview-iframe"></video>`;
            } 
            // éŸ³é¢‘é¢„è§ˆ
            else if (attachment.type.startsWith(`audio/`)) {
                content.innerHTML = `<audio controls src="${attachment.url}" style="width: 100%;"></audio>`;
            } 
            // PDFé¢„è§ˆ
            else if (attachment.type === `application/pdf`) {
                content.innerHTML = `<iframe src="${attachment.url}" class="preview-iframe"></iframe>`;
            } 
            // DOCXé¢„è§ˆï¼ˆæ–°å¢ï¼‰- ä½¿ç”¨Office Web Viewer
            else if (attachment.type === `application/vnd.openxmlformats-officedocument.wordprocessingml.document` || 
                     attachment.name.toLowerCase().endsWith(`.docx`)) {
                
                const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=` + encodeURIComponent(attachment.url);
                
                content.innerHTML = `
                    <iframe id="docxPreviewFrame" src="${officeViewerUrl}" class="preview-iframe" 
                            onload="clearDocxTimeout()" 
                            onerror="showDocxFallback('${attachment.url}', '${escapeHtml(attachment.name)}')">
                    </iframe>
                    <div id="docxFallback" class="preview-fallback" style="display: none;">
                        <div class="preview-fallback-icon">ğŸ“„</div>
                        <div>æ— æ³•é¢„è§ˆDOCXæ–‡ä»¶</div>
                        <button class="download-btn" onclick="downloadFile('${attachment.url}', '${escapeHtml(attachment.name)}')">
                            ä¸‹è½½æ–‡ä»¶
                        </button>
                    </div>
                `;
                
                // è®¾ç½®5ç§’è¶…æ—¶ï¼Œå¦‚æœiframeæœªåŠ è½½æˆåŠŸåˆ™æ˜¾ç¤ºé™çº§æ–¹æ¡ˆ
                window.docxPreviewTimeout = setTimeout(() => {
                    showDocxFallback(attachment.url, attachment.name);
                }, 5000);
            } 
            // å…¶ä»–æ–‡ä»¶ç±»å‹ - æä¾›ä¸‹è½½
            else {
                content.innerHTML = `
                    <div class="preview-fallback">
                        <div class="preview-fallback-icon">ğŸ“„</div>
                        <div>æ— æ³•é¢„è§ˆæ­¤æ–‡ä»¶ç±»å‹</div>
                        <button class="download-btn" onclick="downloadFile('${attachment.url}', '${escapeHtml(attachment.name)}')">
                            ä¸‹è½½æ–‡ä»¶
                        </button>
                    </div>
                `;
            }
            
            modal.classList.add(`active`);
        }

        /**
         * æ¸…é™¤DOCXé¢„è§ˆè¶…æ—¶è®¡æ—¶å™¨
         */
        function clearDocxTimeout() {
            if (window.docxPreviewTimeout) {
                clearTimeout(window.docxPreviewTimeout);
                window.docxPreviewTimeout = null;
            }
        }

        /**
         * æ˜¾ç¤ºDOCXé¢„è§ˆé™çº§æ–¹æ¡ˆ
         * @param {string} url - æ–‡ä»¶URL
         * @param {string} name - æ–‡ä»¶å
         */
        function showDocxFallback(url, name) {
            const iframe = document.getElementById(`docxPreviewFrame`);
            const fallback = document.getElementById(`docxFallback`);
            
            if (iframe && fallback) {
                iframe.style.display = `none`;
                fallback.style.display = `block`;
            }
            
            clearDocxTimeout();
        }

        /**
         * ä¸‹è½½æ–‡ä»¶
         * @param {string} url - æ–‡ä»¶URL
         * @param {string} name - æ–‡ä»¶å
         */
        function downloadFile(url, name) {
            window.open(url, `_blank`);
            showToast(`æ­£åœ¨ä¸‹è½½ ${name}`);
        }

        /**
         * å…³é—­é™„ä»¶é¢„è§ˆæ¨¡æ€æ¡†
         */
        function closeAttachmentModal() {
            document.getElementById(`attachmentModal`).classList.remove(`active`);
            clearDocxTimeout();
        }

        // ========== ç³»ç»Ÿæ¶æ„åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰ ==========
        
        /**
         * æ‰“å¼€ç³»ç»Ÿæ¶æ„æ¨¡æ€æ¡†
         */
        function openArchitectureModal() {
            document.getElementById(`architectureModal`).classList.add(`active`);
        }

        /**
         * å…³é—­ç³»ç»Ÿæ¶æ„æ¨¡æ€æ¡†
         */
        function closeArchitectureModal() {
            document.getElementById(`architectureModal`).classList.remove(`active`);
        }

        // ========== å®æ—¶åŒæ­¥åŠŸèƒ½ ==========
        
        /**
         * è®¾ç½®å®šæ—¶åŒæ­¥ä»»åŠ¡
         * æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
         */
        function setupRealtimeSync() {
            setInterval(async () => {
                await loadTasks();
            }, 30000);
        }

        // ========== å·¥å…·å‡½æ•° ==========
        
        /**
         * æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
         * @param {string} message - æ¶ˆæ¯å†…å®¹
         */
        function showToast(message) {
            const toast = document.getElementById(`toast`);
            toast.textContent = message;
            toast.classList.add(`show`);
            setTimeout(() => { toast.classList.remove(`show`); }, 2000);
        }

        /**
         * HTMLè½¬ä¹‰ï¼Œé˜²æ­¢XSSæ”»å‡»
         * @param {string} text - éœ€è¦è½¬ä¹‰çš„æ–‡æœ¬
         * @returns {string} è½¬ä¹‰åçš„HTML
         */
        function escapeHtml(text) {
            const div = document.createElement(`div`);
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
         * @param {Date} date - æ—¥æœŸå¯¹è±¡
         * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸå­—ç¬¦ä¸²
         */
        function formatDate(date) {
            const d = new Date(date);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (d.toDateString() === today.toDateString()) return `ä»Šå¤©`;
            if (d.toDateString() === tomorrow.toDateString()) return `æ˜å¤©`;
            return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        }

        /**
         * è·å–æ–‡ä»¶ç±»å‹å›¾æ ‡ï¼ˆå¢å¼ºç‰ˆï¼‰
         * @param {string} type - MIMEç±»å‹
         * @param {string} name - æ–‡ä»¶å
         * @returns {string} å›¾æ ‡emoji
         */
        function getFileIcon(type, name) {
            // æ£€æŸ¥DOCXæ–‡ä»¶
            if (type === `application/vnd.openxmlformats-officedocument.wordprocessingml.document` || 
                (name && name.toLowerCase().endsWith(`.docx`))) {
                return `ğŸ“„ DOCX`;
            }
            
            // æ£€æŸ¥å…¶ä»–æ–‡ä»¶ç±»å‹
            if (type.startsWith(`image/`)) return `ğŸ–¼ï¸`;
            if (type.startsWith(`video/`)) return `ğŸ¬`;
            if (type.startsWith(`audio/`)) return `ğŸµ`;
            if (type === `application/pdf`) return `ğŸ“„ PDF`;
            
            return `ğŸ“`;
        }

        // ========== é¡µé¢åŠ è½½åˆå§‹åŒ– ==========
        
        /**
         * é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
         * æ£€æŸ¥æœ¬åœ°å­˜å‚¨ï¼Œè‡ªåŠ¨ç™»å½•å·²æœ‰ç”¨æˆ·
         */
        window.addEventListener(`DOMContentLoaded`, () => {
            const familyId = localStorage.getItem(`familyId`);
            const userRole = localStorage.getItem(`userRole`);
            
            if (familyId && userRole) {
                currentRole = userRole;
                currentFamily = { id: familyId };
                document.getElementById(`loginPage`).classList.add(`hidden`);
                document.getElementById(`mainApp`).classList.remove(`hidden`);
                initApp();
            }
        });

        // ========== å®‰å…¨åŠŸèƒ½ ==========
        
        /**
         * æ‹¦æˆªå¤–éƒ¨é“¾æ¥ç‚¹å‡»ï¼Œé˜²æ­¢æ¶æ„è·³è½¬
         * ä¸å½±å“iframeçš„æ­£å¸¸ä½¿ç”¨
         */
        document.addEventListener(`click`, (e) => {
            if (e.target.tagName === `A` && e.target.href && !e.target.href.startsWith(`data:`)) {
                e.preventDefault();
                showToast(`ä¸ºäº†å®‰å…¨,å·²ç¦ç”¨å¤–éƒ¨é“¾æ¥`);
            }
        });
    </script>
    
    <!-- é¡µé¢ç”Ÿæˆæ—¥æœŸ: 2025-12-11 -->
</body>
</html>
