<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <title>å®¶åº­ä»»åŠ¡åŠ©æ‰‹</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json" type="application/manifest+json">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-color: #4A90E2;
            --success-color: #5CB85C;
            --warning-color: #F0AD4E;
            --danger-color: #D9534F;
            --bg-color: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #E1E8ED;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--card-bg); }
        .hidden { display: none !important; }
        
        /* ç™»å½•é¡µé¢ */
        #loginPage {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            background: white; border-radius: 16px; padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 400px;
        }
        
        .login-title { font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 10px; color: var(--primary-color); }
        .login-subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 14px; }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .input-group input {
            width: 100%; padding: 12px 16px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 16px;
        }
        .input-group input:focus { outline: none; border-color: var(--primary-color); }
        
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #357ABD; transform: translateY(-2px); }
        .btn-secondary { background: var(--text-secondary); color: white; margin-top: 10px; }
        
        .divider {
            text-align: center; margin: 20px 0; color: var(--text-secondary); position: relative;
        }
        .divider::before, .divider::after {
            content: ''; position: absolute; top: 50%; width: 40%; height: 1px;
            background: var(--border-color);
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        
        /* å¤´éƒ¨ */
        .header {
            background: var(--primary-color); color: white; padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-title { font-size: 20px; font-weight: 600; }
        .role-badge {
            background: rgba(255,255,255,0.2); padding: 4px 12px;
            border-radius: 12px; font-size: 14px;
        }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* æµ®åŠ¨æŒ‰é’® */
        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
            background: var(--primary-color); border-radius: 50%; border: none;
            color: white; font-size: 28px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;
        }
        .fab:hover { transform: scale(1.1); }
        
        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            padding: 20px; background: var(--bg-color);
        }
        .stat-card {
            background: white; padding: 16px; border-radius: 12px;
            text-align: center; box-shadow: var(--shadow);
        }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary-color); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list { padding: 0 20px 80px 20px; }
        .task-section-title {
            font-size: 14px; font-weight: 600; color: var(--text-secondary);
            margin: 20px 0 10px 0; text-transform: uppercase;
        }
        
        .task-card {
            background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px;
            box-shadow: var(--shadow); border-left: 4px solid transparent;
        }
        .task-card.priority-high { border-left-color: var(--danger-color); }
        .task-card.priority-medium { border-left-color: var(--warning-color); }
        .task-card.priority-low { border-left-color: var(--success-color); }
        .task-card.completed { opacity: 0.6; background: #f9f9f9; }
        
        .task-header { display: flex; align-items: flex-start; gap: 12px; }
        .task-checkbox {
            width: 24px; height: 24px; min-width: 24px; border: 2px solid var(--border-color);
            border-radius: 6px; cursor: pointer; display: flex; align-items: center;
            justify-content: center;
        }
        .task-checkbox:hover { border-color: var(--primary-color); }
        .task-checkbox.checked {
            background: var(--success-color); border-color: var(--success-color);
        }
        .task-checkbox.checked::after {
            content: 'âœ“'; color: white; font-size: 16px; font-weight: bold;
        }
        
        .task-content { flex: 1; }
        .task-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .task-title.completed { text-decoration: line-through; color: var(--text-secondary); }
        .task-description { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        
        .task-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .task-tag {
            display: inline-block; padding: 4px 10px; background: var(--bg-color);
            border-radius: 12px; font-size: 12px; color: var(--text-secondary);
        }
        .task-due-date { font-size: 12px; color: var(--text-secondary); }
        .task-due-date.overdue { color: var(--danger-color); font-weight: 600; }
        
        .task-attachments { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
        .attachment-item {
            padding: 6px 12px; background: var(--bg-color); border-radius: 8px;
            font-size: 13px; color: var(--primary-color); cursor: pointer;
        }
        .attachment-item:hover { background: #e3f2fd; }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }

        /* å…³é”®æ”¹åŠ¨ï¼šmodal-contenté‡‡ç”¨flexçºµå‘å¸ƒå±€ï¼Œé™åˆ¶æ€»é«˜ï¼›é™„ä»¶å†…å®¹åŒºæ»šåŠ¨ */
        .modal-content {
            background: white; border-radius: 16px; padding: 24px;
            width: 90%; max-width: 500px; max-height: 90vh;
            display: flex; flex-direction: column;
            overflow: hidden; /* è®©æ»šåŠ¨å‘ç”Ÿåœ¨å†…å®¹åŒº */
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
            flex: 0 0 auto; /* å¤´éƒ¨å›ºå®šé«˜åº¦ */
            position: sticky; top: 0; z-index: 10; background: #fff; /* å§‹ç»ˆå¯è§ */
        }
        #attachmentContent{
            flex: 1 1 auto; /* å¡«å……å‰©ä½™ç©ºé—´ */
            overflow: auto; /* åªæ»šåŠ¨å†…å®¹åŒºï¼Œä¸å½±å“å¤´éƒ¨ */
            display: flex; flex-direction: column;
            min-height: 0; /* å…è®¸flexå­é¡¹åœ¨å®¹å™¨å†…æ­£ç¡®æ”¶ç¼© */
        }

        .modal-title { font-size: 20px; font-weight: 600; }
        .close-btn {
            background: none; border: none; font-size: 28px;
            cursor: pointer; color: var(--text-secondary);
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%; padding: 10px 12px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 14px;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus { outline: none; border-color: var(--primary-color); }
        
        .file-upload {
            border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer;
        }
        .file-upload:hover { border-color: var(--primary-color); background: var(--bg-color); }
        .file-upload input { display: none; }
        
        .uploaded-files { margin-top: 12px; }
        .uploaded-file {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: var(--bg-color); border-radius: 8px; margin-bottom: 8px;
        }
        .remove-file {
            background: var(--danger-color); color: white; border: none;
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
        }
        
        .empty-state {
            text-align: center; padding: 60px 20px; color: var(--text-secondary);
        }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        
        /* ä¿®å¤æŒ‰é’®ç‚¹å‡»ä¸çµæ•ï¼štoast é»˜è®¤ä¸æ‹¦æˆªç‚¹å‡»ï¼Œæ˜¾ç¤ºæ—¶æ‰å…è®¸ç‚¹å‡» */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 24px; font-size: 14px; z-index: 3000; opacity: 0;
            pointer-events: none; /* å…³é”®ï¼šé»˜è®¤ä¸æ‹¦æˆªç‚¹å‡» */
        }
        .toast.show { opacity: 1; pointer-events: auto; } /* ä»…æ˜¾ç¤ºæ—¶å¯ç‚¹å‡»/å¯å…³é—­ */
        
        /* é¢„è§ˆåŸºç¡€æ ·å¼ */
        .preview-iframe {
            width: 100%;
            height: 70vh;
            border: none;
            border-radius: 8px;
        }
        .preview-fallback {
            text-align: center;
            padding: 40px;
        }
        .preview-fallback-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .download-btn {
            display: inline-block;
            margin-top: 12px;
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .download-btn:hover { background: #357ABD; }

        /* é¢„è§ˆå·¥å…·æ ä¸å…¨å±ï¼ˆä¿ç•™å¹¶è°ƒæ•´ï¼‰ */
        .preview-toolbar{
            display:flex; gap:8px; justify-content:flex-end; align-items:center;
            margin:8px 0; position: sticky; top:0; background:#fff; z-index:5;
            padding:8px 0; border-bottom:1px solid var(--border-color);
            flex: 0 0 auto; /* å·¥å…·æ ä¸æŒ¤å‹å†…å®¹åŒº */
        }
        .tool-btn{
            padding:6px 10px; border:1px solid var(--border-color); background:#fff;
            border-radius:6px; cursor:pointer; font-size:13px; color:var(--text-primary);
        }
        .tool-btn.primary{ background:var(--primary-color); color:#fff; border-color:var(--primary-color); }

        /* å…³é”®æ”¹åŠ¨ï¼šimage-wrapé‡‡ç”¨flexå¡«å……ï¼Œæ™®é€š/å…¨å±è‡ªé€‚åº”ï¼Œå›¾ç‰‡å±…ä¸­contain */
        .image-wrap{
            width:100%;
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
            position: relative;
            background:#00000008; border-radius:8px;
            display: flex; align-items: center; justify-content: center;
        }
        .image-wrap img{
            max-width:100%; max-height:100%;
            width: auto; height: auto;
            transform-origin:center center;
            user-select:none; -webkit-user-drag:none; touch-action:none;
            display:block; margin:0 auto;
            object-fit: contain; /* ä¿æŒå®Œæ•´å¯è§ */
        }

        .modal.fullscreen .modal-content{
            width:100vw; height:100vh; max-width:none; max-height:none;
            border-radius:0; padding:12px;
        }
        .modal.fullscreen #attachmentContent{
            flex: 1 1 auto; /* å…¨å±æ¨¡å¼ä¸‹ä»å¡«å……å‰©ä½™ç©ºé—´ */
        }
        .modal.fullscreen .preview-iframe{ height:calc(100vh - 100px); }
        body.no-scroll{ overflow:hidden; }
        
        @media (max-width: 480px) {
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
            .stat-card:last-child { grid-column: 1 / -1; }
            .preview-iframe { height: 50vh; }
            /* ç§»åŠ¨ç«¯ä¸‹ï¼Œå†…å®¹åŒºä»é‡‡ç”¨flexå¡«å……ï¼Œimage-wrapä¸ä½¿ç”¨å›ºå®šé«˜åº¦ */
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage">
        <div class="login-card">
            <h1 class="login-title">ğŸ‘¨â€ğŸ‘§ å®¶åº­ä»»åŠ¡åŠ©æ‰‹</h1>
            <p class="login-subtitle">è®©ä»»åŠ¡ç®¡ç†æ›´ç®€å•</p>
            
            <div id="loginForm">
                <div class="input-group">
                    <label>å®¶åº­é‚€è¯·ç </label>
                    <input type="text" id="inviteCodeInput" placeholder="è¾“å…¥6ä½é‚€è¯·ç " maxlength="6">
                </div>
                <button class="btn btn-primary" onclick="loginWithCode()">ç™»å½•</button>
                <div class="divider">æˆ–</div>
                <button class="btn btn-secondary" onclick="createFamily()">åˆ›å»ºæ–°å®¶åº­</button>
            </div>

            <div id="roleSelection" class="hidden">
                <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">è¯·é€‰æ‹©ä½ çš„è§’è‰²</p>
                <button class="btn btn-primary" onclick="selectRole('parent')">ğŸ‘¨â€ğŸ’¼ å®¶é•¿æ¨¡å¼</button>
                <button class="btn btn-secondary" onclick="selectRole('child')">ğŸ‘§ å­©å­æ¨¡å¼</button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <!-- å¤´éƒ¨å¯¼èˆª -->
            <div class="header">
                <div>
                    <div class="header-title">å®¶åº­ä»»åŠ¡</div>
                    <div class="role-badge" id="roleBadge"></div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="switchRole()" title="åˆ‡æ¢è§’è‰²">ğŸ”„</button>
                    <button class="icon-btn" onclick="logout()" title="é€€å‡º">ğŸšª</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div id="statsPanel" class="stats-panel hidden">
                <div class="stat-card">
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">æ€»ä»»åŠ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedTasks">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completionRate">0%</div>
                    <div class="stat-label">å®Œæˆç‡</div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="task-list" id="taskList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- åˆ›å»ºä»»åŠ¡æµ®åŠ¨æŒ‰é’® -->
            <button id="createTaskBtn" class="fab hidden" onclick="openCreateTaskModal()">+</button>
        </div>
    </div>

    <!-- åˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡† -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åˆ›å»ºæ–°ä»»åŠ¡</h2>
                <button class="close-btn" onclick="closeCreateTaskModal()">&times;</button>
            </div>
            
            <form id="taskForm" onsubmit="createTask(event)">
                <div class="form-group">
                    <label>ä»»åŠ¡æ ‡é¢˜ *</label>
                    <input type="text" id="taskTitle" required placeholder="ä¾‹å¦‚:å®Œæˆæ•°å­¦ä½œä¸š">
                </div>

                <div class="form-group">
                    <label>ä»»åŠ¡æè¿°</label>
                    <textarea id="taskDescription" placeholder="è¯¦ç»†è¯´æ˜ä»»åŠ¡è¦æ±‚..."></textarea>
                </div>

                <div class="form-group">
                    <label>æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="taskDueDate">
                </div>

                <div class="form-group">
                    <label>ä¼˜å…ˆçº§</label>
                    <select id="taskPriority">
                        <option value="low">ä½</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="high">é«˜</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾(ç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="taskTags" placeholder="ä¾‹å¦‚:ä½œä¸š,æ•°å­¦">
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ é™„ä»¶</label>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <div>ğŸ“ ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                            æ”¯æŒPDFã€DOCXã€å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘
                        </div>
                        <input type="file" id="fileInput" multiple
                          accept=".pdf,.docx,.doc,.jpg,.jpeg,.png,.gif,.mp3,.mp4,.wav,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                          onchange="handleFileSelect(event)">
                    </div>
                    <div id="uploadedFilesList" class="uploaded-files"></div>
                </div>

                <button type="submit" class="btn btn-primary">åˆ›å»ºä»»åŠ¡</button>
            </form>
        </div>
    </div>

    <!-- é™„ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="attachmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="attachmentTitle">æŸ¥çœ‹é™„ä»¶</h2>
                <div>
                    <!-- å…¨å±æŒ‰é’® -->
                    <button class="tool-btn" id="fullscreenBtn" onclick="toggleAttachmentFullscreen()" title="å…¨å±/é€€å‡ºå…¨å±">â›¶</button>
                    <button class="close-btn" onclick="closeAttachmentModal()">&times;</button>
                </div>
            </div>
            <div id="attachmentContent"></div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div id="toast" class="toast"></div>

    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    
    <script>
        // ========== LeanCloud é…ç½® ==========
        const LEANCLOUD_APP_ID = `YOUR_APP_ID`;
        const LEANCLOUD_APP_KEY = `YOUR_APP_KEY`;
        const LEANCLOUD_SERVER_URL = `https://YOUR_SERVER_URL.lc-cn-n1-shared.com`;

        AV.init({
            appId: '63f8haa3tIFFuiTc2HeDuEyU-gzGzoHsz',
            appKey: 'SXeVLTnReJKeptXMnlR98Z8J',
            serverURL: 'https://63f8haa3.lc-cn-n1-shared.com'
        });

        // ========== å…¨å±€å˜é‡ ==========
        let currentUser = null;
        let currentRole = null;
        let currentFamily = null;
        let tasks = [];
        let uploadedFiles = [];

        // ========== å®¶åº­ç®¡ç†åŠŸèƒ½ ==========
        async function createFamily() {
            try {
                showToast(`æ­£åœ¨åˆ›å»ºå®¶åº­...`);
                const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const Family = AV.Object.extend(`Family`);
                const family = new Family();
                family.set(`inviteCode`, inviteCode);
                family.set(`createdAt`, new Date());
                await family.save();
                
                localStorage.setItem(`familyId`, family.id);
                localStorage.setItem(`inviteCode`, inviteCode);
                
                alert(`å®¶åº­åˆ›å»ºæˆåŠŸ!\n\né‚€è¯·ç :${inviteCode}\n\nè¯·å°†æ­¤é‚€è¯·ç åˆ†äº«ç»™å­©å­`);
                currentFamily = family;
                showRoleSelection();
            } catch (error) {
                console.error(`åˆ›å»ºå®¶åº­å¤±è´¥:`, error);
                showToast(`åˆ›å»ºå¤±è´¥,è¯·é‡è¯•`);
            }
        }

        async function loginWithCode() {
            const code = document.getElementById(`inviteCodeInput`).value.trim().toUpperCase();
            if (!code || code.length !== 6) {
                showToast(`è¯·è¾“å…¥6ä½é‚€è¯·ç `);
                return;
            }
            try {
                showToast(`æ­£åœ¨éªŒè¯é‚€è¯·ç ...`);
                const query = new AV.Query(`Family`);
                query.equalTo(`inviteCode`, code);
                const family = await query.first();
                if (!family) {
                    showToast(`é‚€è¯·ç æ— æ•ˆ`);
                    return;
                }
                localStorage.setItem(`familyId`, family.id);
                localStorage.setItem(`inviteCode`, code);
                currentFamily = family;
                showRoleSelection();
            } catch (error) {
                console.error(`ç™»å½•å¤±è´¥:`, error);
                showToast(`ç™»å½•å¤±è´¥,è¯·é‡è¯•`);
            }
        }

        function showRoleSelection() {
            document.getElementById(`loginForm`).classList.add(`hidden`);
            document.getElementById(`roleSelection`).classList.remove(`hidden`);
        }

        function selectRole(role) {
            currentRole = role;
            localStorage.setItem(`userRole`, role);
            document.getElementById(`loginPage`).classList.add(`hidden`);
            document.getElementById(`mainApp`).classList.remove(`hidden`);
            initApp();
        }

        function switchRole() {
            const newRole = currentRole === `parent` ? `child` : `parent`;
            selectRole(newRole);
        }

        function logout() {
            if (confirm(`ç¡®å®šè¦é€€å‡ºå—?`)) {
                localStorage.clear();
                location.reload();
            }
        }

        // ========== åº”ç”¨åˆå§‹åŒ– ==========
        async function initApp() {
            const roleBadge = document.getElementById(`roleBadge`);
            roleBadge.textContent = currentRole === `parent` ? `ğŸ‘¨â€ğŸ’¼ å®¶é•¿` : `ğŸ‘§ å­©å­`;
            if (currentRole === `parent`) {
                document.getElementById(`statsPanel`).classList.remove(`hidden`);
                document.getElementById(`createTaskBtn`).classList.remove(`hidden`);
            } else {
                document.getElementById(`statsPanel`).classList.add(`hidden`);
                document.getElementById(`createTaskBtn`).classList.add(`hidden`);
            }
            await loadTasks();
            setupRealtimeSync();
        }

        // ========== ä»»åŠ¡ç®¡ç†åŠŸèƒ½ ==========
        async function loadTasks() {
            try {
                const familyId = localStorage.getItem(`familyId`);
                const query = new AV.Query(`Task`);
                query.equalTo(`familyId`, familyId);
                query.descending(`createdAt`);
                const results = await query.find();
                
                tasks = results.map(obj => ({
                    id: obj.id,
                    ...obj.toJSON()
                }));
                
                renderTasks();
                updateStats();
            } catch (error) {
                console.error(`åŠ è½½ä»»åŠ¡å¤±è´¥:`, error);
                showToast(`åŠ è½½å¤±è´¥`);
            }
        }

        function renderTasks() {
            const taskList = document.getElementById(`taskList`);
            if (tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>è¿˜æ²¡æœ‰ä»»åŠ¡</div>
                        ${currentRole === `parent` ? `<div style="margin-top: 8px; font-size: 14px;">ç‚¹å‡»å³ä¸‹è§’ + åˆ›å»ºä»»åŠ¡</div>` : ``}
                    </div>
                `;
                return;
            }
            const pending = tasks.filter(t => !t.completed);
            const completed = tasks.filter(t => t.completed);
            let html = ``;
            if (pending.length > 0) {
                html += `<div class="task-section-title">å¾…å®Œæˆ</div>`;
                pending.forEach(task => { html += renderTaskCard(task); });
            }
            if (completed.length > 0) {
                html += `<div class="task-section-title">å·²å®Œæˆ</div>`;
                completed.forEach(task => { html += renderTaskCard(task); });
            }
            taskList.innerHTML = html;
        }

        function renderTaskCard(task) {
            const dueDate = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = dueDate && dueDate < new Date() && !task.completed;
            return `
                <div class="task-card priority-${task.priority} ${task.completed ? `completed` : ``}">
                    <div class="task-header">
                        <div class="task-checkbox ${task.completed ? `checked` : ``}" onclick="toggleTask('${task.id}')"></div>
                        <div class="task-content">
                            <div class="task-title ${task.completed ? `completed` : ``}">
                                ${escapeHtml(task.title)}
                            </div>
                            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ``}
                            <div class="task-meta">
                                ${task.tags && task.tags.length > 0 ? task.tags.map(tag => 
                                    `<span class="task-tag">#${escapeHtml(tag)}</span>`
                                ).join(``) : ``}
                                ${dueDate ? `
                                    <div class="task-due-date ${isOverdue ? `overdue` : ``}">
                                        ğŸ“… ${formatDate(dueDate)}
                                    </div>
                                ` : ``}
                            </div>
                            ${task.attachments && task.attachments.length > 0 ? `
                                <div class="task-attachments">
                                    ${task.attachments.map((att, idx) => `
                                        <div class="attachment-item" onclick="viewAttachment('${task.id}', ${idx})">
                                            ${getFileIcon(att.type, att.name)} ${escapeHtml(att.name)}
                                        </div>
                                    `).join(``)}
                                </div>
                            ` : ``}
                        </div>
                    </div>
                </div>
            `;
        }

        async function toggleTask(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;
                const Task = AV.Object.createWithoutData(`Task`, taskId);
                Task.set(`completed`, !task.completed);
                Task.set(`completedAt`, !task.completed ? new Date() : null);
                await Task.save();
                
                task.completed = !task.completed;
                task.completedAt = task.completed ? new Date() : null;
                
                renderTasks();
                updateStats();
                showToast(task.completed ? `âœ“ ä»»åŠ¡å·²å®Œæˆ` : `ä»»åŠ¡æ ‡è®°ä¸ºæœªå®Œæˆ`);
            } catch (error) {
                console.error(`æ›´æ–°ä»»åŠ¡å¤±è´¥:`, error);
                showToast(`æ“ä½œå¤±è´¥`);
            }
        }

        function updateStats() {
            if (currentRole !== `parent`) return;
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById(`totalTasks`).textContent = total;
            document.getElementById(`completedTasks`).textContent = completed;
            document.getElementById(`completionRate`).textContent = rate + `%`;
        }

        // ========== åˆ›å»ºä»»åŠ¡åŠŸèƒ½ ==========
        function openCreateTaskModal() {
            document.getElementById(`createTaskModal`).classList.add(`active`);
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById(`taskDueDate`).value = tomorrow.toISOString().split(`T`)[0];
        }

        function closeCreateTaskModal() {
            document.getElementById(`createTaskModal`).classList.remove(`active`);
            document.getElementById(`taskForm`).reset();
            uploadedFiles = [];
            document.getElementById(`uploadedFilesList`).innerHTML = ``;
        }

        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name} è¶…è¿‡10MBé™åˆ¶`);
                    continue;
                }
                try {
                    showToast(`æ­£åœ¨ä¸Šä¼ ...`);
                    const avFile = new AV.File(file.name, file);
                    await avFile.save();
                    const secureUrl = toHttps(avFile.url());
                    uploadedFiles.push({ name: file.name, url: secureUrl, type: file.type });
                    renderUploadedFiles();
                    showToast(`${file.name} ä¸Šä¼ æˆåŠŸ`);
                } catch (error) {
                    console.error(`ä¸Šä¼ å¤±è´¥:`, error);
                    showToast(`${file.name} ä¸Šä¼ å¤±è´¥`);
                }
            }
            event.target.value = ``;
        }

        function renderUploadedFiles() {
            const list = document.getElementById(`uploadedFilesList`);
            list.innerHTML = uploadedFiles.map((file, idx) => `
                <div class="uploaded-file">
                    <span>${getFileIcon(file.type, file.name)} ${escapeHtml(file.name)}</span>
                    <button type="button" class="remove-file" onclick="removeFile(${idx})">&times;</button>
                </div>
            `).join(``);
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderUploadedFiles();
        }

        async function createTask(event) {
            event.preventDefault();
            try {
                showToast(`æ­£åœ¨åˆ›å»ºä»»åŠ¡...`);
                const title = document.getElementById(`taskTitle`).value.trim();
                const description = document.getElementById(`taskDescription`).value.trim();
                const dueDate = document.getElementById(`taskDueDate`).value;
                const priority = document.getElementById(`taskPriority`).value;
                const tagsInput = document.getElementById(`taskTags`).value.trim();
                const tags = tagsInput ? tagsInput.split(`,`).map(t => t.trim()).filter(t => t) : [];
                
                const Task = AV.Object.extend(`Task`);
                const task = new Task();
                task.set(`familyId`, localStorage.getItem(`familyId`));
                task.set(`title`, title);
                task.set(`description`, description);
                task.set(`dueDate`, dueDate ? new Date(dueDate) : null);
                task.set(`priority`, priority);
                task.set(`tags`, tags);
                task.set(`attachments`, uploadedFiles);
                task.set(`completed`, false);
                task.set(`createdBy`, `parent`);
                await task.save();
                
                showToast(`âœ“ ä»»åŠ¡åˆ›å»ºæˆåŠŸ`);
                closeCreateTaskModal();
                await loadTasks();
            } catch (error) {
                console.error(`åˆ›å»ºä»»åŠ¡å¤±è´¥:`, error);
                showToast(`åˆ›å»ºå¤±è´¥,è¯·é‡è¯•`);
            }
        }

        // ========== é™„ä»¶é¢„è§ˆåŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼‰ ==========
        function viewAttachment(taskId, attachmentIndex) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.attachments || !task.attachments[attachmentIndex]) return;
            const attachment = task.attachments[attachmentIndex];
            const modal = document.getElementById(`attachmentModal`);
            const title = document.getElementById(`attachmentTitle`);
            const content = document.getElementById(`attachmentContent`);
            title.textContent = attachment.name;
            const safeUrl = toHttps(attachment.url);
            content.innerHTML = ``;

            // å›¾ç‰‡é¢„è§ˆï¼šæ–°å¢æ”¾å¤§/ç¼©å°/å¤ä½ä¸ä¸‹è½½æŒ‰é’®ï¼ˆå®¹å™¨å·²æ”¹ä¸ºflexè‡ªé€‚åº”ï¼‰
            if (attachment.type.startsWith(`image/`)) {
                content.innerHTML = `
                  <div class="preview-toolbar">
                    <button class="tool-btn" onclick="zoomImage(0.2)">æ”¾å¤§+</button>
                    <button class="tool-btn" onclick="zoomImage(-0.2)">ç¼©å°-</button>
                    <button class="tool-btn" onclick="resetImageZoom()">å¤ä½</button>
                    <button class="tool-btn primary" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½</button>
                  </div>
                  <div class="image-wrap">
                    <img id="previewImg" src="${safeUrl}" alt="${escapeHtml(attachment.name)}">
                  </div>
                `;
                const imgEl = document.getElementById('previewImg');
                setupImageZoom(imgEl);
            }
            else if (attachment.type.startsWith(`video/`)) {
                content.innerHTML = `
                  <div class="preview-toolbar">
                    <button class="tool-btn primary" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½è§†é¢‘</button>
                  </div>
                  <video controls src="${safeUrl}" class="preview-iframe"></video>
                `;
            }
            else if (attachment.type.startsWith(`audio/`)) {
                content.innerHTML = `
                  <div class="preview-toolbar">
                    <button class="tool-btn primary" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½éŸ³é¢‘</button>
                  </div>
                  <audio controls src="${safeUrl}" style="width: 100%;"></audio>
                `;
            }
            // PDFï¼šiOS ä¼˜å…ˆç”¨ pdf.js æ¸²æŸ“ï¼Œå…¶ä»–å¹³å°ä¿ç•™åŸ viewerï¼Œå¹¶éƒ½æä¾›ä¸‹è½½/å¤–éƒ¨æ‰“å¼€
            else if (isPDF(attachment)) {
                if (isIOS()) {
                    content.innerHTML = `
                      <div class="preview-toolbar">
                        <button class="tool-btn" onclick="pdfZoom(0.2)">æ”¾å¤§+</button>
                        <button class="tool-btn" onclick="pdfZoom(-0.2)">ç¼©å°-</button>
                        <button class="tool-btn" onclick="pdfZoomReset()">å¤ä½</button>
                        <button class="tool-btn primary" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½PDF</button>
                      </div>
                      <div id="pdfCanvasContainer" style="height:70vh; overflow:auto; background:#f9f9f9; border-radius:8px; padding:8px;"></div>
                    `;
                    renderPdfWithPdfJs(safeUrl, 'pdfCanvasContainer');
                } else {
                    const viewerUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=` + encodeURIComponent(safeUrl);
                    content.innerHTML = `
                      <div class="preview-toolbar">
                        <button class="tool-btn primary" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½PDF</button>
                        <button class="tool-btn" onclick="openExternal('${safeUrl}')">æ–°çª—å£æ‰“å¼€</button>
                      </div>
                      <iframe src="${viewerUrl}" class="preview-iframe" allowfullscreen></iframe>
                    `;
                }
            }
            // DOCX/DOC é¢„è§ˆï¼šä¿æŒåŸé€»è¾‘ï¼Œå¢åŠ ä¸Šæ–¹å·¥å…·æ çš„ä¸‹è½½æŒ‰é’®
            else if (isDOCX(attachment) || isDOC(attachment) || attachment.name.toLowerCase().endsWith('.docx') || attachment.name.toLowerCase().endsWith('.doc')) {
                const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=` + encodeURIComponent(safeUrl);
                content.innerHTML = `
                  <div class="preview-toolbar">
                    <button class="tool-btn primary" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½æ–‡ä»¶</button>
                  </div>
                  <iframe id="docxPreviewFrame" src="${officeViewerUrl}" class="preview-iframe"
                          onload="clearDocxTimeout()" onerror="showDocxFallback('${safeUrl}', '${escapeHtml(attachment.name)}')">
                  </iframe>
                  <div id="docxFallback" class="preview-fallback" style="display: none;">
                    <div class="preview-fallback-icon">ğŸ“„</div>
                    <div>æ— æ³•é¢„è§ˆè¯¥Wordæ–‡ä»¶</div>
                    <button class="download-btn" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½æ–‡ä»¶</button>
                  </div>
                `;
                window.docxPreviewTimeout = setTimeout(() => { showDocxFallback(safeUrl, attachment.name); }, 5000);
            }
            else {
                content.innerHTML = `
                  <div class="preview-fallback">
                    <div class="preview-fallback-icon">ğŸ“„</div>
                    <div>æ— æ³•é¢„è§ˆæ­¤æ–‡ä»¶ç±»å‹</div>
                    <button class="download-btn" onclick="downloadFile('${safeUrl}', '${escapeHtml(attachment.name)}')">ä¸‹è½½æ–‡ä»¶</button>
                  </div>
                `;
            }
            modal.classList.add(`active`);
        }

        function clearDocxTimeout() {
            if (window.docxPreviewTimeout) {
                clearTimeout(window.docxPreviewTimeout);
                window.docxPreviewTimeout = null;
            }
        }

        function showDocxFallback(url, name) {
            const iframe = document.getElementById(`docxPreviewFrame`);
            const fallback = document.getElementById(`docxFallback`);
            if (iframe && fallback) {
                iframe.style.display = `none`;
                fallback.style.display = `block`;
            }
            clearDocxTimeout();
        }

        // ä¸‹è½½æ–‡ä»¶ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
        async function downloadFile(url, name) {
          const safeUrl = toHttps(url);
          const ua = navigator.userAgent || '';
          const isIOS = /iPhone|iPad|iPod/i.test(ua);
          const isAndroid = /Android/i.test(ua);
          const isWeChat = /MicroMessenger/i.test(ua);
          const isMobileSafari = isIOS && /Safari/i.test(ua) && !/CriOS|FxiOS/i.test(ua);

          try {
            if (isMobileSafari || isWeChat) {
              window.open(safeUrl, '_blank', 'noopener');
              showToast(`å·²åœ¨æ–°çª—å£æ‰“å¼€ ${name}`);
              return;
            }
            const supportsDownloadAttr = 'download' in document.createElement('a');
            if (!supportsDownloadAttr && (isAndroid || isIOS)) {
              window.open(safeUrl, '_blank', 'noopener');
              showToast(`å·²åœ¨æ–°çª—å£æ‰“å¼€ ${name}`);
              return;
            }
            const res = await fetch(safeUrl, { mode: 'cors' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const blob = await res.blob();
            const objectUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectUrl;
            a.download = name || 'download';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(objectUrl);
            showToast(`æ­£åœ¨ä¸‹è½½ ${name}`);
          } catch (e) {
            window.open(safeUrl, '_blank', 'noopener');
            showToast(`å·²åœ¨æ–°çª—å£æ‰“å¼€ ${name}`);
          }
        }

        function closeAttachmentModal() {
            document.getElementById(`attachmentModal`).classList.remove(`active`, 'fullscreen');
            document.body.classList.remove('no-scroll');
            clearDocxTimeout();
        }

        // é™„ä»¶å…¨å±åˆ‡æ¢ï¼ˆä¿ç•™ï¼Œé…åˆflexå¸ƒå±€ç”Ÿæ•ˆï¼‰
        function toggleAttachmentFullscreen(){
            const modal = document.getElementById('attachmentModal');
            modal.classList.toggle('fullscreen');
            document.body.classList.toggle('no-scroll', modal.classList.contains('fullscreen'));
        }

        // å›¾ç‰‡ç¼©æ”¾ä¸æ‹–æ‹½ï¼ˆä¿ç•™é€»è¾‘ï¼‰
        let imageZoomState = { scale: 1, x: 0, y: 0, img: null, dragging: false, startX:0, startY:0 };
        function setupImageZoom(imgEl){
            imageZoomState = { scale:1, x:0, y:0, img:imgEl, dragging:false, startX:0, startY:0 };
            applyImageTransform();
            imgEl.addEventListener('mousedown', onImgPointerDown);
            imgEl.addEventListener('touchstart', onImgPointerDown, { passive:false });
            document.addEventListener('mousemove', onImgPointerMove);
            document.addEventListener('touchmove', onImgPointerMove, { passive:false });
            document.addEventListener('mouseup', onImgPointerUp);
            document.addEventListener('touchend', onImgPointerUp);
            imgEl.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                zoomImage(delta);
            }, { passive:false });
        }
        function zoomImage(delta){
            if (!imageZoomState.img) return;
            imageZoomState.scale = Math.max(1, Math.min(5, imageZoomState.scale + delta));
            applyImageTransform();
        }
        function resetImageZoom(){
            if (!imageZoomState.img) return;
            imageZoomState.scale = 1; imageZoomState.x = 0; imageZoomState.y = 0;
            applyImageTransform();
        }
        function applyImageTransform(){
            const { img, scale, x, y } = imageZoomState;
            if (!img) return;
            img.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
        }
        function onImgPointerDown(e){
            if (!imageZoomState.img || imageZoomState.scale === 1) return;
            e.preventDefault();
            imageZoomState.dragging = true;
            const p = getPoint(e);
            imageZoomState.startX = p.x - imageZoomState.x;
            imageZoomState.startY = p.y - imageZoomState.y;
        }
        function onImgPointerMove(e){
            if (!imageZoomState.dragging) return;
            e.preventDefault();
            const p = getPoint(e);
            imageZoomState.x = p.x - imageZoomState.startX;
            imageZoomState.y = p.y - imageZoomState.startY;
            applyImageTransform();
        }
        function onImgPointerUp(){ imageZoomState.dragging = false; }
        function getPoint(e){
            if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        }

        // PDF.js è½½å…¥ä¸æ¸²æŸ“ï¼ˆiOS ä¼˜å…ˆï¼‰
        function isIOS(){ return /iPhone|iPad|iPod/i.test(navigator.userAgent || ''); }
        function openExternal(url){ window.open(url, '_blank', 'noopener'); }

        function loadPdfJsIfNeeded(){
            if (window.pdfjsLib) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
                s.onload = () => {
                    try{
                        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
                        resolve();
                    }catch(err){ reject(err); }
                };
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        async function renderPdfWithPdfJs(url, containerId){
            try{
                await loadPdfJsIfNeeded();
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const pdf = await window.pdfjsLib.getDocument({ url }).promise;
                const maxPages = Math.min(pdf.numPages, 20); // é˜²æ­¢è¶…å¤šé¡µé¢å½±å“æ€§èƒ½
                for (let i=1; i<=maxPages; i++){
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.2 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    canvas.style.display = 'block';
                    canvas.style.margin = '0 auto 8px auto';
                    container.appendChild(canvas);
                    await page.render({ canvasContext: ctx, viewport }).promise;
                }
                container.dataset.scale = '1';
            }catch(err){
                openExternal(url);
                showToast('PDF é¢„è§ˆå¤±è´¥ï¼Œå·²åœ¨æ–°çª—å£æ‰“å¼€');
            }
        }
        function pdfZoom(delta){
            const c = document.getElementById('pdfCanvasContainer');
            if (!c) return;
            let s = parseFloat(c.dataset.scale || '1');
            s = Math.max(0.5, Math.min(3, s + delta));
            c.dataset.scale = String(s);
            c.style.transform = `scale(${s})`;
            c.style.transformOrigin = '0 0';
        }
        function pdfZoomReset(){
            const c = document.getElementById('pdfCanvasContainer');
            if (!c) return;
            c.dataset.scale = '1';
            c.style.transform = 'none';
        }

        // ========== å®æ—¶åŒæ­¥åŠŸèƒ½ ==========
        function setupRealtimeSync() {
            setInterval(async () => {
                await loadTasks();
            }, 30000);
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function showToast(message) {
            const toast = document.getElementById(`toast`);
            toast.textContent = message;
            toast.classList.add(`show`);
            setTimeout(() => { toast.classList.remove(`show`); }, 2000);
        }

        function toHttps(url) {
          try {
            if (!url) return '';
            return url.replace(/^http:/i, 'https:');
          } catch (e) { return url; }
        }

        function fileExt(name) {
          if (!name) return '';
          const idx = name.lastIndexOf('.');
          return idx >= 0 ? name.substring(idx + 1).toLowerCase() : '';
        }
        function isPDF(att) {
          return att.type === 'application/pdf' || /\.pdf$/i.test(att.name || '');
        }
        function isDOCX(att) {
          return att.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                 || /\.docx$/i.test(att.name || '');
        }
        function isDOC(att) {
          return att.type === 'application/msword' || /\.doc$/i.test(att.name || '');
        }

        function escapeHtml(text) {
            const div = document.createElement(`div`);
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            const d = new Date(date);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            if (d.toDateString() === today.toDateString()) return `ä»Šå¤©`;
            if (d.toDateString() === tomorrow.toDateString()) return `æ˜å¤©`;
            return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        }

        function getFileIcon(type, name) {
            const ext = fileExt(name || '');
            if (type.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (type.startsWith('video/')) return 'ğŸ¬';
            if (type.startsWith('audio/')) return 'ğŸµ';
            if (type === 'application/pdf' || ext === 'pdf') return 'ğŸ“„ PDF';
            if (type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || ext === 'docx') return 'ğŸ“„ DOCX';
            if (type === 'application/msword' || ext === 'doc') return 'ğŸ“„ DOC';
            return 'ğŸ“';
        }

        // ========== é¡µé¢åŠ è½½åˆå§‹åŒ– ==========
        window.addEventListener(`DOMContentLoaded`, () => {
            const familyId = localStorage.getItem(`familyId`);
            const userRole = localStorage.getItem(`userRole`);
            if (familyId && userRole) {
                currentRole = userRole;
                currentFamily = { id: familyId };
                document.getElementById(`loginPage`).classList.add(`hidden`);
                document.getElementById(`mainApp`).classList.remove(`hidden`);
                initApp();
            }
        });

        // ========== å®‰å…¨åŠŸèƒ½ ==========
        document.addEventListener('click', (e) => {
            const a = e.target.closest('a');
            if (!a) return;
            const href = a.getAttribute('href') || '';
            const isData = href.startsWith('data:');
            const isSameOrigin = href.startsWith(location.origin);
            const isDownload = a.classList.contains('download-btn') || a.getAttribute('download') !== null || a.dataset.allowExternal === 'true';
            if (!isData && !isSameOrigin && !isDownload) {
                e.preventDefault();
                showToast(`ä¸ºäº†å®‰å…¨,å·²ç¦ç”¨å¤–éƒ¨é“¾æ¥`);
            }
        });
    </script>
    
    <!-- é¡µé¢ç”Ÿæˆæ—¥æœŸ: 2025-12-11 -->
</body>
</html>
